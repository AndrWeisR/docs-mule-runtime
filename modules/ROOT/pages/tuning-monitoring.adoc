= Performance Monitoring
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]

To complement the best practices for performance, it is necessary to monitor the exhausted and consumed resources by Mule runtime engine (Mule) during the tests. The following categories can help to monitor the main system resources. Additionally, learn what tools to use for CloudHub monitoring.  +
The commands provided in the next sections are for a Linux SO with sysstat installed.


== CPU Resource
Increased load can exhaust CPU resources. There are several ways to monitor these resources, two of them are:

* Top command: `top` +
The `%CPU` metric equals to the CPU usage divided by the number of cores.

.Top command CPU stats
image::mruntime-tuning-monitoring-top.png[Top command CPU stats]

* Sar command: `sar -u  ALL $INTERVAL $COUNT` +
Where `$INTERVAL` specifies the time interval to obtain the metrics, and `$COUNT` specifies the number of data points to collect. +
Main metrics to pay attention are:

** `%usr` shows how much CPU is used at the user level (application).
** `%sys` shows how much CPU is used at system level (kernel).
** `%idle` shows the percentage of time that the CPU was idle.

.Sar command CPU stats
image::mruntime-tuning-sar-cpu.png[Sar command CPU stats]

== Memory Resource
To understand how Mule uses memory, including heap and native memory or off-heap buffers, monitor the memory via several ways, two of them are:

* GC Log +
Enable GC (Garbage Collection) logging to obtain allocation rate, object growth, and so on. Additionally, obtain information about the activities in the heap. Notice that enabling GC logging has a light overhead on the disk.

.CG Log wrapper.conf
image::mruntime-tuning-wrapper.png[wrapper.conf]

* Sar command: `sar -r $INTERVAL $COUNT` +
Main metrics to pay attention are:

** `kbmemfree` shows the amount of free memory available in kilobytes.
** `kbmemused` shows the amount of used memory in kilobytes.
** `kbcommit` shows the amount of memory in kilobytes needed for the current workload, which estimates how much RAM or swap is required to guarantee that it doesn't run out of memory.

.Sar command memory stats
image::mruntime-tuning-sar-memory.png[Sar command Memory stats]

== Disk Resource
Some Mule components log writing operations and scenarios with large payloads treated as repeatable streams exhibit, where the exhausted resource are I/O (input or output) requests. Monitor the disk resource using the Sar command `sar -d -p $INTERVAL $COUNT`.

Main metrics to pay attention are:

** `await` shows the average time in milliseconds for I/O requests issued to serve to the device to, which includes the time spent by the requests in the queue and the time spent servicing them.
** `%util` helps to understand the saturation of the device showing the percentage of CPU time during which I/O requests are issued to bandwidth utilization for the device.

.Sar command disk stats
image::mruntime-tuning-sar-disk.png[Sar command Disk stats]

== Network Resource
One of the main purposes of Mule is to interconnect with several services that communicate by the net. Because of this, the network infrastructure can become a bottleneck and saturated. You need to know the bandwidth and monitor the utilization, a simple way to do it is using the Sar command `sar -n DEV $INTERVAL $COUNT`.

Main metrics to pay attention are:

** `rxpck/s` shows the total number of packets received per second.
** `txpck/s` shows the total number of packets transmitted per second.


.Sar command network stats
image::mruntime-tuning-sar-network.png[Sar command Network stats]

== CloudHub Monitoring
To monitor Mule apps performance running in a CloudHub environment, you can use:

* Runtime Manager Dashboard +
The tool allows you to visualize key performance metrics such as messages or transactions, CPU and memory usage, and specific time period metrics such as last hour, last 24 hours and last week.

.Runtime Manager Dashboard
image::mruntime-tuning-runtimemanager.png[Runtime Manager Dashboard]

* Anypoint Monitoring +
The tool enables you to keep track and visualize your performance metrics by using built-in or custom dashboards exposing the metrics of your applications through visual representations of your resources. Additionally, the tool enables you to detect anomalies, troubleshoot issues, and see trends differently from the raw form.

.Anypoint Monitoring Dashboard
image::mruntime-tuning-anypointmonitoring.png[Anypoint Monitoring Dashboard]

== See Also
* https://man7.org/linux/man-pages/man1/top.1.html[Top Linux Commands]
* https://linux.die.net/man/1/sar[Sar Linux Commands]
